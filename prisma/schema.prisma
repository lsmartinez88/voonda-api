generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("DATABASE_URL")
}

model Empresa {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre      String   @db.VarChar(200)
  descripcion String?  @db.Text
  logo_url    String?  @db.Text
  activa      Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  usuarios    Usuario[]
  vehiculos   Vehiculo[]
  vendedores  Vendedor[]
  compradores Comprador[]
  operaciones Operacion[]

  @@index([activa])
  @@map("empresas")
}

model Rol {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre      String   @unique @db.VarChar(50)
  descripcion String?  @db.Text
  permisos    Json?    @db.JsonB
  activo      Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  usuarios Usuario[]

  @@index([activo])
  @@map("roles")
}

model Usuario {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email    String  @unique @db.VarChar(255)
  password String  @db.VarChar(255)
  nombre   String  @db.VarChar(200)
  apellido String? @db.VarChar(200)
  telefono String? @db.VarChar(20)
  activo   Boolean @default(true)

  empresa_id String?  @db.Uuid
  empresa    Empresa? @relation(fields: [empresa_id], references: [id])
  
  rol_id String @db.Uuid
  rol    Rol    @relation(fields: [rol_id], references: [id])

  ultimo_login      DateTime? @db.Timestamptz(6)
  intentos_fallidos Int       @default(0)
  bloqueado_hasta   DateTime? @db.Timestamptz(6)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([empresa_id])
  @@index([rol_id])
  @@index([activo])
  @@index([email])
  @@map("usuarios")
}

model ModeloAuto {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  marca           String  @db.Text
  modelo          String  @db.Text
  version         String? @db.Text
  modelo_ano      Int
  segmento_modelo String? @db.Text

  motorizacion      String?  @db.Text
  combustible       String?  @db.Text
  caja              String?  @db.Text
  traccion          String?  @db.Text
  cilindrada        Int?
  potencia_hp       Int?
  torque_nm         Int?
  rendimiento_mixto Decimal? @db.Decimal(5, 2)

  equipamiento       String[] @default([])
  asistencias_manejo String[] @default([])

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  vehiculos Vehiculo[]

  @@unique([marca, modelo, version, modelo_ano])
  @@index([marca, modelo])
  @@map("modelo_autos")
}

model Vehiculo {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  empresa_id              String   @db.Uuid
  modelo_id               String   @db.Uuid
  patente                 String?  @db.Text
  vehiculo_ano            Int
  kilometros              Int      @default(0)
  valor                   Decimal? @db.Decimal(12, 2)
  moneda                  String   @default("ARS") @db.Text
  estado_id               String?  @db.Uuid
  tipo_operacion          String?  @db.Text
  fecha_ingreso           DateTime? @db.Timestamptz(6)
  observaciones           String?  @db.Text
  pendientes_preparacion  String[] @default([])
  comentarios             String?  @db.Text
  activo                  Boolean  @default(true)

  vendedor_id  String? @db.Uuid
  comprador_id String? @db.Uuid

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  empresa       Empresa                @relation(fields: [empresa_id], references: [id])
  modelo        ModeloAuto             @relation(fields: [modelo_id], references: [id])
  estado        EstadoVehiculo?        @relation(fields: [estado_id], references: [id])
  vendedor      Vendedor?              @relation(fields: [vendedor_id], references: [id])
  comprador     Comprador?             @relation(fields: [comprador_id], references: [id])
  operaciones   Operacion[]
  imagenes      ImagenVehiculo[]
  publicaciones PublicacionVehiculo[]

  @@index([empresa_id])
  @@index([modelo_id])
  @@index([estado_id])
  @@index([vendedor_id])
  @@index([comprador_id])
  @@map("vehiculos")
}

model Vendedor {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  empresa_id    String  @db.Uuid
  nombre        String  @db.Text
  apellido      String? @db.Text
  telefono      String? @db.Text
  email         String? @db.Text
  dni           String? @db.Text
  direccion     String? @db.Text
  observaciones String? @db.Text
  activo        Boolean @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  empresa     Empresa     @relation(fields: [empresa_id], references: [id])
  vehiculos   Vehiculo[]
  operaciones Operacion[]

  @@index([empresa_id])
  @@index([telefono])
  @@index([email])
  @@map("vendedores")
}

model Comprador {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  empresa_id    String  @db.Uuid
  nombre        String  @db.Text
  apellido      String? @db.Text
  telefono      String? @db.Text
  email         String? @db.Text
  dni           String? @db.Text
  direccion     String? @db.Text
  observaciones String? @db.Text
  activo        Boolean @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  empresa     Empresa     @relation(fields: [empresa_id], references: [id])
  vehiculos   Vehiculo[]
  operaciones Operacion[]

  @@index([empresa_id])
  @@index([telefono])
  @@index([email])
  @@map("compradores")
}

model Operacion {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  empresa_id  String   @db.Uuid
  vehiculo_id String   @db.Uuid
  tipo        String   @db.Text
  fecha       DateTime @db.Date
  monto       Decimal? @db.Decimal(12, 2)
  moneda      String   @default("ARS") @db.Text
  estado      String   @default("pendiente") @db.Text

  vendedor_id  String? @db.Uuid
  comprador_id String? @db.Uuid

  datos_especificos Json? @db.JsonB
  observaciones     String? @db.Text

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  empresa   Empresa    @relation(fields: [empresa_id], references: [id])
  vehiculo  Vehiculo   @relation(fields: [vehiculo_id], references: [id])
  vendedor  Vendedor?  @relation(fields: [vendedor_id], references: [id])
  comprador Comprador? @relation(fields: [comprador_id], references: [id])

  @@index([empresa_id])
  @@index([vehiculo_id])
  @@index([tipo])
  @@index([fecha])
  @@index([estado])
  @@index([vendedor_id])
  @@index([comprador_id])
  @@map("operaciones")
}

model EstadoVehiculo {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  codigo      String   @unique @db.VarChar(50)
  nombre      String   @db.VarChar(100)
  descripcion String?  @db.Text
  activo      Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  vehiculos Vehiculo[]

  @@index([codigo])
  @@index([activo])
  @@map("estados_vehiculo")
}

model ImagenVehiculo {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehiculo_id  String   @db.Uuid
  url          String   @db.Text
  descripcion  String?  @db.Text
  orden        Int      @default(1)
  es_principal Boolean  @default(false)
  activo       Boolean  @default(true)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  vehiculo Vehiculo @relation(fields: [vehiculo_id], references: [id], onDelete: Cascade)

  @@index([vehiculo_id])
  @@index([es_principal])
  @@index([activo])
  @@map("imagenes_vehiculo")
}

model PublicacionVehiculo {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vehiculo_id      String   @db.Uuid
  plataforma       String   @db.VarChar(50) // facebook, web, mercadolibre, instagram, whatsapp, olx, autocosmos, otro
  url_publicacion  String?  @db.Text
  id_publicacion   String?  @db.VarChar(100)
  titulo           String   @db.VarChar(200)
  ficha_breve      String?  @db.Text
  activo           Boolean  @default(true)
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  vehiculo Vehiculo @relation(fields: [vehiculo_id], references: [id], onDelete: Cascade)

  @@index([vehiculo_id])
  @@index([plataforma])
  @@index([activo])
  @@map("publicaciones_vehiculo")
}

model Imagen {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre      String   @db.VarChar(200)
  url         String   @db.Text
  tipo        String   @db.VarChar(50) // vehiculo, perfil, documento, etc
  descripcion String?  @db.Text
  tamaño      Int?     // tamaño en bytes
  formato     String?  @db.VarChar(10) // jpg, png, pdf, etc
  activo      Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([tipo])
  @@index([activo])
  @@map("imagenes")
}