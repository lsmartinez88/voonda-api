// Prisma schema para Voonda API - Sistema de gestión de vehículos
// Basado en la estructura de Supabase PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL") // Cambiado para usar pooling
}

// ====================================
// ESTRUCTURA MULTI-EMPRESA Y USUARIOS
// ====================================

// Tabla de empresas - núcleo del sistema multi-tenant
model Empresa {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre      String   @db.VarChar(200)
  descripcion String?  @db.Text
  logo_url    String?  @db.Text
  activa      Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  usuarios           Usuario[]
  vehiculos          Vehiculo[]
  vendedores         Vendedor[]
  compradores        Comprador[]
  operaciones_venta  OperacionVenta[]
  operaciones_compra OperacionCompra[]

  @@index([activa], name: "idx_empresas_activa")
  @@map("empresas")
}

// Tabla de roles del sistema
model Rol {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre      String   @unique @db.VarChar(50) // colaborador, administrador_empresa, administrador_general
  descripcion String?  @db.Text
  permisos    Json?    @db.JsonB // Estructura JSON con permisos específicos
  activo      Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  usuarios Usuario[]

  @@index([activo], name: "idx_roles_activo")
  @@map("roles")
}

// Modelo de usuarios mejorado con empresa y roles
model Usuario {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email    String  @unique @db.VarChar(255)
  password String  @db.VarChar(255)
  nombre   String  @db.VarChar(200)
  apellido String? @db.VarChar(200)
  telefono String? @db.VarChar(20)
  activo   Boolean @default(true)

  // Relación con empresa (null para administrador general)
  empresa_id String?  @db.Uuid
  empresa    Empresa? @relation(fields: [empresa_id], references: [id])

  // Relación con rol
  rol_id String @db.Uuid
  rol    Rol    @relation(fields: [rol_id], references: [id])

  // Metadatos de auditoría
  ultimo_login      DateTime? @db.Timestamptz(6)
  intentos_fallidos Int       @default(0)
  bloqueado_hasta   DateTime? @db.Timestamptz(6)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([empresa_id], name: "idx_usuarios_empresa_id")
  @@index([rol_id], name: "idx_usuarios_rol_id")
  @@index([activo], name: "idx_usuarios_activo")
  @@index([email], name: "idx_usuarios_email")
  @@map("usuarios")
}

// Tabla de referencia de modelos de autos (GENÉRICA - Sin empresa_id)
// Define las características estándar de cada modelo, marca, versión y año
model ModeloAuto {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Información básica del modelo
  marca           String  @db.Text
  modelo          String  @db.Text
  version         String? @db.Text
  modelo_ano      Int
  segmento_modelo String? @db.Text

  // Especificaciones técnicas del motor
  motorizacion      String?  @db.Text
  combustible       String?  @db.Text
  caja              String?  @db.Text
  traccion          String?  @db.Text
  cilindrada        Int?
  potencia_hp       Int?
  torque_nm         Int?
  rendimiento_mixto Decimal? @db.Decimal(5, 2)
  velocidad_max     Int?

  // Dimensiones físicas
  largo                 Int?
  ancho                 Int?
  alto                  Int?
  capacidad_baul        Int?
  capacidad_combustible Int?

  // Equipamiento y seguridad
  airbags             Int?
  abs                 Boolean? @default(false)
  control_estabilidad Boolean? @default(false)
  climatizador        Boolean? @default(false)
  multimedia          String?  @db.Text
  frenos              String?  @db.Text
  neumaticos          String?  @db.Text
  llantas             String?  @db.Text

  // NUEVOS CAMPOS AGREGADOS
  // Lista de equipamiento completo del vehículo (JSON array de strings)
  equipamiento String[] @default([]) // Array de strings con todo el equipamiento

  // Lista de asistencias de manejo (JSON array de strings)
  asistencias_manejo String[] @default([]) // Array de strings: ["Control crucero", "Alerta punto ciego", etc.]

  // Información adicional
  url_ficha   String? @db.Text
  ficha_breve String? @db.Text
  modelo_rag  String? @db.Text

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  vehiculos Vehiculo[]

  @@unique([marca, modelo, version, modelo_ano], name: "modelo_autos_unique_cols")
  @@index([marca, modelo], name: "idx_modelo_autos_marca_modelo")
  @@map("modelo_autos")
}

// Tabla de estados de vehículo (global, reutilizable)
model EstadoVehiculo {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  codigo      String   @unique @db.VarChar(100)
  nombre      String   @db.VarChar(200)
  descripcion String?  @db.Text
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  vehiculos Vehiculo[]

  @@index([codigo], name: "idx_estadovehiculo_codigo")
  @@map("estados_vehiculos")
}

// Tabla de vehículos - Representa unidades individuales disponibles, reservadas o vendidas
model Vehiculo {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia a empresa (OBLIGATORIA)
  empresa_id String  @db.Uuid
  empresa    Empresa @relation(fields: [empresa_id], references: [id])

  // Referencia al modelo (OBLIGATORIA)
  modelo_id   String     @db.Uuid
  modelo_auto ModeloAuto @relation(fields: [modelo_id], references: [id])

  // Información específica de la unidad
  patente        String?         @db.Text
  vehiculo_ano   Int
  kilometros     Int             @default(0)
  valor          Decimal?        @db.Decimal(12, 2)
  moneda         String?         @default("ARS") @db.Text
  // Estado ahora referenciado desde la tabla EstadoVehiculo
  estado_id      String?         @db.Uuid
  estado         EstadoVehiculo? @relation(fields: [estado_id], references: [id])
  tipo_operacion String?         @db.Text
  fecha_ingreso  DateTime?       @db.Date
  observaciones  String?         @db.Text

  // NUEVOS CAMPOS AGREGADOS
  // Pendientes de preparación (texto libre)
  pendientes_preparacion String? @db.Text

  // Comentarios adicionales del vehículo (texto libre)
  comentarios String? @db.Text

  // Referencias a vendedor y comprador
  vendedor_id String?   @db.Uuid
  vendedor    Vendedor? @relation(fields: [vendedor_id], references: [id])

  comprador_id String?    @db.Uuid
  comprador    Comprador? @relation(fields: [comprador_id], references: [id])

  // Campo para soft delete
  activo Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  publicaciones      Publicacion[]
  operaciones_venta  OperacionVenta[]
  operaciones_compra OperacionCompra[]
  imagenes           ImagenVehiculo[]

  @@index([empresa_id], name: "idx_vehiculos_empresa_id")
  @@index([modelo_id], name: "idx_vehiculos_modelo_id")
  @@index([estado_id], name: "idx_vehiculos_estado_id")
  @@index([valor], name: "idx_vehiculos_valor")
  @@index([fecha_ingreso], name: "idx_vehiculos_fecha_ingreso")
  @@index([patente], name: "idx_vehiculos_patente")
  @@index([vendedor_id], name: "idx_vehiculos_vendedor_id")
  @@index([comprador_id], name: "idx_vehiculos_comprador_id")
  @@map("vehiculos")
}

// Tabla de publicaciones - Registra las publicaciones de vehículos en plataformas
model Publicacion {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia al vehículo (OBLIGATORIA) - un vehículo puede tener muchas publicaciones
  vehiculo_id String   @db.Uuid
  vehiculo    Vehiculo @relation(fields: [vehiculo_id], references: [id], onDelete: Cascade)

  // Información de la plataforma
  plataforma             String  @db.Text // "facebook", "web", "mercadolibre", "autocosmos", etc.
  url_publicacion        String? @db.Text // URL completa de la publicación
  id_publicacion_externa String? @db.Text // ID en la plataforma externa (ej: ID de ML, Facebook, etc.)

  // Contenido de la publicación
  titulo      String  @db.Text // Título de la publicación
  ficha_breve String? @db.Text // Descripción breve del vehículo

  // Estado de la publicación
  activo Boolean @default(true) // true = activo, false = no activo/pausado

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Índices para optimizar consultas
  @@index([vehiculo_id], name: "idx_publicaciones_vehiculo_id")
  @@index([plataforma], name: "idx_publicaciones_plataforma")
  @@index([activo], name: "idx_publicaciones_activo")
  @@index([plataforma, activo], name: "idx_publicaciones_plataforma_activo")
  @@map("publicaciones")
}

// Tabla de imágenes de vehículos - Almacena URLs de imágenes
model ImagenVehiculo {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia al vehículo (OBLIGATORIA)
  vehiculo_id String   @db.Uuid
  vehiculo    Vehiculo @relation(fields: [vehiculo_id], references: [id], onDelete: Cascade)

  // Información de la imagen
  url_imagen   String  @db.Text // URL de la imagen (puede ser subida o externa)
  titulo       String? @db.Text // Título o descripción de la imagen
  orden        Int     @default(0) // Orden de visualización
  es_principal Boolean @default(false) // Indica si es la imagen principal

  // Estado
  activo Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([vehiculo_id], name: "idx_imagenes_vehiculo_id")
  @@index([orden], name: "idx_imagenes_orden")
  @@index([es_principal], name: "idx_imagenes_principal")
  @@map("imagenes_vehiculos")
}

// Tabla de vendedores - Personas que venden vehículos a la empresa
model Vendedor {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia a empresa (OBLIGATORIA)
  empresa_id String  @db.Uuid
  empresa    Empresa @relation(fields: [empresa_id], references: [id])

  // Información del vendedor
  nombre        String  @db.Text
  apellido      String? @db.Text
  telefono      String? @db.Text
  email         String? @db.Text
  dni           String? @db.Text
  direccion     String? @db.Text
  ciudad        String? @db.Text
  provincia     String? @db.Text
  codigo_postal String? @db.Text
  origen        String? @db.Text // ¿Cómo llegó a la empresa?
  comentarios   String? @db.Text

  // Estado
  activo Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  vehiculos          Vehiculo[]
  operaciones_compra OperacionCompra[] @relation("VendedorOperacionCompra")

  @@index([empresa_id], name: "idx_vendedores_empresa_id")
  @@index([telefono], name: "idx_vendedores_telefono")
  @@index([email], name: "idx_vendedores_email")
  @@index([dni], name: "idx_vendedores_dni")
  @@map("vendedores")
}

// Tabla de compradores - Personas que compran vehículos de la empresa
model Comprador {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia a empresa (OBLIGATORIA)
  empresa_id String  @db.Uuid
  empresa    Empresa @relation(fields: [empresa_id], references: [id])

  // Información del comprador
  nombre        String  @db.Text
  apellido      String? @db.Text
  telefono      String? @db.Text
  email         String? @db.Text
  dni           String? @db.Text
  direccion     String? @db.Text
  ciudad        String? @db.Text
  provincia     String? @db.Text
  codigo_postal String? @db.Text
  origen        String? @db.Text // ¿Cómo llegó a la empresa?
  comentarios   String? @db.Text

  // Estado
  activo Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  vehiculos         Vehiculo[]
  operaciones_venta OperacionVenta[] @relation("CompradorOperacionVenta")

  @@index([empresa_id], name: "idx_compradores_empresa_id")
  @@index([telefono], name: "idx_compradores_telefono")
  @@index([email], name: "idx_compradores_email")
  @@index([dni], name: "idx_compradores_dni")
  @@map("compradores")
}

// Tabla de operaciones de venta - Registro detallado de ventas realizadas
model OperacionVenta {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia a empresa (OBLIGATORIA)
  empresa_id String  @db.Uuid
  empresa    Empresa @relation(fields: [empresa_id], references: [id])

  // Referencias (OBLIGATORIAS)
  vehiculo_id String   @db.Uuid
  vehiculo    Vehiculo @relation(fields: [vehiculo_id], references: [id])

  comprador_id String    @db.Uuid
  comprador    Comprador @relation("CompradorOperacionVenta", fields: [comprador_id], references: [id])

  // Información de la transacción
  precio_venta  Decimal   @db.Decimal(12, 2)
  moneda        String    @default("ARS") @db.Text
  forma_pago    String?   @db.Text // "Contado", "Financiado", "Permuta", etc.
  fecha_venta   DateTime  @db.Date
  fecha_entrega DateTime? @db.Date

  // Detalles adicionales
  comision_vendedor    Decimal? @db.Decimal(12, 2)
  gastos_transferencia Decimal? @db.Decimal(12, 2)
  otros_gastos         Decimal? @db.Decimal(12, 2)
  observaciones        String?  @db.Text

  // Estado de la operación
  estado String @default("Completada") @db.Text // "Pendiente", "Completada", "Cancelada"

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([empresa_id], name: "idx_operaciones_venta_empresa_id")
  @@index([vehiculo_id], name: "idx_operaciones_venta_vehiculo_id")
  @@index([comprador_id], name: "idx_operaciones_venta_comprador_id")
  @@index([fecha_venta], name: "idx_operaciones_venta_fecha_venta")
  @@index([estado], name: "idx_operaciones_venta_estado")
  @@map("operaciones_venta")
}

// Tabla de operaciones de compra - Registro detallado de compras realizadas
model OperacionCompra {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Referencia a empresa (OBLIGATORIA)
  empresa_id String  @db.Uuid
  empresa    Empresa @relation(fields: [empresa_id], references: [id])

  // Referencias (OBLIGATORIAS)
  vehiculo_id String   @db.Uuid
  vehiculo    Vehiculo @relation(fields: [vehiculo_id], references: [id])

  vendedor_id String   @db.Uuid
  vendedor    Vendedor @relation("VendedorOperacionCompra", fields: [vendedor_id], references: [id])

  // Información de la transacción
  precio_compra   Decimal   @db.Decimal(12, 2)
  moneda          String    @default("ARS") @db.Text
  forma_pago      String?   @db.Text // "Contado", "Transferencia", "Cheque", etc.
  fecha_compra    DateTime  @db.Date
  fecha_recepcion DateTime? @db.Date

  // Detalles adicionales
  gastos_transferencia Decimal? @db.Decimal(12, 2)
  gastos_reparacion    Decimal? @db.Decimal(12, 2)
  otros_gastos         Decimal? @db.Decimal(12, 2)
  observaciones        String?  @db.Text

  // Estado de la operación
  estado String @default("Completada") @db.Text // "Pendiente", "Completada", "Cancelada"

  // Timestamps
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([empresa_id], name: "idx_operaciones_compra_empresa_id")
  @@index([vehiculo_id], name: "idx_operaciones_compra_vehiculo_id")
  @@index([vendedor_id], name: "idx_operaciones_compra_vendedor_id")
  @@index([fecha_compra], name: "idx_operaciones_compra_fecha_compra")
  @@index([estado], name: "idx_operaciones_compra_estado")
  @@map("operaciones_compra")
}
